name: Goose

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  PROVIDER_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  PR_NUMBER: ${{ github.event.pull_request.number }}

jobs:
  goose-comment:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up GitHub CLI
        uses: actions/setup-gh@v4

      - name: Gather PR information
        run: |
          {
            echo "# Files Changed"
            gh pr view "$PR_NUMBER" --json files \
              -q '.files[] | "* " + .path + " (" + (.additions|tostring) + " additions, " + (.deletions|tostring) + " deletions)"'
            echo ""
            echo "# Changes Summary"
            gh pr diff "$PR_NUMBER"
          } > changes.txt

      - name: Install Goose CLI
        run: |
          mkdir -p /home/runner/.local/bin
          curl -fsSL https://github.com/block/goose/releases/download/stable/download_cli.sh | \
            CONFIGURE=false INSTALL_PATH=/home/runner/.local/bin bash
          echo "/home/runner/.local/bin" >> $GITHUB_PATH

      - name: Configure Goose
        run: |
          mkdir -p ~/.config/goose
          echo "GOOSE_PROVIDER: OpenAI" > ~/.config/goose/config.yaml
          echo "GOOSE_MODEL: o3" >> ~/.config/goose/config.yaml
          echo "keyring: false" >> ~/.config/goose/config.yaml

      - name: Create instructions for Goose
        run: |
          echo "Create a summary of the changes provided. Don't provide any session or logging details." > instructions.txt
          echo "The summary for each file should be brief and structured as:" >> instructions.txt
          echo "\`<filename/path>\`" >> instructions.txt
          echo "  - dot points of changes" >> instructions.txt
          echo "You don't need any extensions, don't mention extensions at all." >> instructions.txt
          echo "The changes to summarise are:" >> instructions.txt
          cat changes.txt >> instructions.txt

      - name: Show instructions (debug)
        run: cat instructions.txt

      - name: Run Goose and filter output
        run: |
          goose run --instructions instructions.txt | \
            sed -E 's/\x1B\[[0-9;]*[mK]//g' | \
            grep -v "logging to /home/runner/.config/goose/sessions/" | \
            grep -v "^starting session" | \
            grep -v "^Closing session" | \
            sed 's/[[:space:]]*$//' > pr_comment.txt

      - name: Post comment to PR
        run: gh pr comment "$PR_NUMBER" --body-file pr_comment.txt
