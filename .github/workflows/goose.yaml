name: Goose PR Summary Comment

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]

permissions:
  pull-requests: write   # needed for gh pr comment
  contents: read

env:                     # <<— Goose looks for PROVIDER_API_KEY
  PROVIDER_API_KEY: ${{ secrets.OPENAI_API_KEY }}   # rename secret if you prefer
  GOOSE_DISABLE_KEYRING: "1"                        # skip desktop keyring

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with: {fetch-depth: 0}

    - name: Ensure jq is present
      run: sudo apt-get update -y && sudo apt-get install -y jq

    - name: Authenticate gh
      run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

    # ── Install Goose ─────────────────────────────────────────────────────
    - name: Install Goose CLI
      run: |
        mkdir -p "$HOME/.local/bin"
        curl -fsSL https://github.com/block/goose/releases/download/stable/download_cli.sh \
          | CONFIGURE=false INSTALL_PATH="$HOME/.local/bin" bash
        echo "$HOME/.local/bin" >> "$GITHUB_PATH"

    - name: Tiny Goose config
      run: |
        mkdir -p ~/.config/goose
        printf 'GOOSE_PROVIDER: openai\nGOOSE_MODEL: gpt-4o\nkeyring: false\n' \
          > ~/.config/goose/config.yaml

    # ── Gather the full diff and feed it to Goose ────────────────────────
    - name: Build diff summary with Goose
      id: goose_summarise
      run: |
        # Pull full unified diff
        gh pr diff ${{ github.event.pull_request.number }} > full.patch

        # Create instruction
        printf '%s\n' \
          "You are a senior engineer reviewing a pull request." \
          "" \
          "Summarise the changes below; point out any potential issues and praise good practices." \
          "Keep it under 250 words; bullet points welcome." \
          "" \
          "Diff follows:" \
          "$(cat full.patch)" > instructions.txt

        # Run Goose
        COMMENT=$(goose run --instructions instructions.txt)
        echo "COMMENT<<EOF" >> $GITHUB_ENV
        echo "$COMMENT"     >> $GITHUB_ENV
        echo "EOF"          >> $GITHUB_ENV

    # ── Post one top-level PR comment ────────────────────────────────────
    - name: Post summary comment
      run: |
        gh pr comment ${{ github.event.pull_request.number }} \
          --body "$COMMENT"
